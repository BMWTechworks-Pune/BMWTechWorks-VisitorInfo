<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTI Pune ‚Äì Visitor Info</title>
  <style>
    :root { --bg:#0b1f3b; --card:#112d58; --accent:#00d1b2; --text:#e8f0ff; --muted:#bcd2ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 18px 16px; text-align: center; background: linear-gradient(90deg,#0b1f3b 0%,#13325f 100%); border-bottom: 1px solid #1f3f74; }
    h1 { margin:0; font-size: 26px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width: 1024px){ .grid { grid-template-columns: 1.25fr 0.75fr; } }
    .card { background: var(--card); border:1px solid #1f3f74; border-radius:12px; overflow:hidden; }
    .card h2 { margin:0; padding:12px 16px; font-size:18px; border-bottom:1px solid #1f3f74; background: rgba(0,0,0,0.08); }
    .content { padding: 12px 16px; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid #2e5baa; color:var(--text); background:#163b72; padding:10px 14px; border-radius:8px; cursor:pointer; text-decoration:none; }
    .btn:hover { filter: brightness(1.1); }
    .select { background:#0a264e; border:1px solid #214a8a; color:var(--text); padding:10px 8px; border-radius:8px; }
    .muted { color: var(--muted); font-size: 14px; }

    .zoom-wrap { position: relative; height: 64vh; min-height: 380px; background:#0a264e; border:1px solid #214a8a; border-radius:10px; overflow:hidden; }
    .zoom-inner { position:absolute; top:0; left:0; transform-origin:0 0; cursor: grab; transition: transform 180ms ease; }
    .zoom-inner.dragging { cursor:grabbing; transition: none; }
    .zoom-hint { position:absolute; bottom:10px; right:12px; background:rgba(0,0,0,0.35); color:#e8f0ff; padding:6px 10px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,0.2); }

    /* Overlay markers */
    #overlay { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
    .marker { fill: rgba(0,209,178,0.12); stroke: #00d1b2; stroke-width:2; pointer-events:auto; }
    .marker:hover { fill: rgba(0,209,178,0.25); }
    .pulse { animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%{ filter: drop-shadow(0 0 0 #00d1b2);} 50%{ filter: drop-shadow(0 0 6px #00d1b2);} 100%{ filter: drop-shadow(0 0 0 #00d1b2);} }

    .tools { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .route-tools { display:grid; grid-template-columns: 1fr 1fr auto auto; gap:8px; margin-top:12px; }
    @media(max-width:640px){ .route-tools { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>BTI Pune ‚Äì Visitor Information</h1>
    <p class="muted">Zoomable exit plan ‚Ä¢ Tap-to-play audio ‚Ä¢ Room route finder ‚Ä¢ QR share</p>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h2>Exit Plan (Zoom ‚Ä¢ Pan ‚Ä¢ Fullscreen)</h2>
        <div class="content">
          <div class="zoom-wrap" id="zoomWrap">
            <img id="zoomImg" class="zoom-inner" src="r1.png" alt="BTI Pune Exit Plan" />
            <svg id="overlay"></svg>
            <div class="zoom-hint">Scroll/pinch to zoom ‚Ä¢ Drag to pan ‚Ä¢ Double‚Äëtap to reset</div>
          </div>

          <div class="tools">
            <button class="btn" id="btnSpeak">üîä Play Audio Guidance</button>
            <button class="btn" id="btnStop">‚èπ Stop</button>
            <button class="btn" id="btnReset">‚Ü∫ Reset</button>
            <button class="btn" id="btnZoomIn">‚ûï Zoom In</button>
            <button class="btn" id="btnZoomOut">‚ûñ Zoom Out</button>
            <button class="btn" id="btnFullscreen">‚õ∂ Fullscreen</button>
          </div>

          <div class="route-tools">
            <select id="fromRoom" class="select"></select>
            <select id="toRoom" class="select"></select>
            <button class="btn" id="btnRoute">üß≠ Show Route</button>
            <button class="btn" id="btnClear">üßπ Clear</button>
          </div>
          <p class="muted" id="routeText"></p>
        </div>
      </section>

      <aside class="card">
        <h2>Quick References & QR</h2>
        <div class="content">
          <div style="display:grid; grid-template-columns:1fr; gap:12px;">
            <div class="img-item"><img src="r5.png" alt="Lanyards" style="width:100%; border-radius:8px"/><p class="muted">Lanyards: Employee ‚Ä¢ Contractor ‚Ä¢ Visitor ‚Ä¢ BMW Employee</p></div>
            <div class="img-item"><img src="r2.png" alt="Access Zones" style="width:100%; border-radius:8px"/><p class="muted">Access policy map: A‚ÄìG zones with restrictions.</p></div>
            <div class="img-item"><img src="r3.png" alt="Rooms & Areas" style="width:100%; border-radius:8px"/><p class="muted">Rooms: Success, Inspire, Joy, Debug, iDrive, M‚ÄëMode, Drift, xDrive, Torque.</p></div>
          </div>

          <hr style="margin:16px 0; border-color:#1f3f74"/>

          <p><strong>Share via QR:</strong></p>
          <img src="updated_qr.png" alt="QR" style="max-width:240px; border:1px solid #214a8a; border-radius:8px; background:#0a264e; padding:8px"/>
          <div class="tools">
            <a class="btn" download="BTI_Pune_QR.png" href="updated_qr.png">‚¨áÔ∏è Download QR</a>
            <button class="btn" id="btnPrint">üñ®Ô∏è Print</button>
          </div>
          <p class="muted">URL: <a href="https://bmwtechworks-pune.github.io/BMWTechWorks-VisitorInfo/" target="_blank">Open site</a></p>
        </div>
      </aside>
    </div>
  </div>

  <footer style="text-align:center; padding:18px; color:var(--muted)">¬© BTI Pune ‚Äî Visitor Info.</footer>

  <script>
    // --- Zoom & Pan with smooth animation ---
    (function(){
      const wrap = document.getElementById('zoomWrap');
      const img = document.getElementById('zoomImg');
      let scale = 1, min=1, max=6; let ox=0, oy=0; let down=false, sx=0, sy=0;
      function apply(){ img.style.transform = `translate(${ox}px, ${oy}px) scale(${scale})`; }
      function clamp(){ const bw=wrap.clientWidth, bh=wrap.clientHeight; const iw=img.naturalWidth, ih=img.naturalHeight; const vw=iw*scale, vh=ih*scale; const minX=Math.min(0,bw-vw), minY=Math.min(0,bh-vh); ox=Math.max(minX, Math.min(ox, 0)); oy=Math.max(minY, Math.min(oy, 0)); }
      wrap.addEventListener('wheel', (e)=>{ e.preventDefault(); const rect=wrap.getBoundingClientRect(); const mx=e.clientX-rect.left, my=e.clientY-rect.top; const prev=scale; const delta=e.deltaY<0?1.12:0.9; scale=Math.min(max,Math.max(min, scale*delta)); ox=mx-(mx-ox)*(scale/prev); oy=my-(my-oy)*(scale/prev); clamp(); apply(); }, {passive:false});
      wrap.addEventListener('mousedown', (e)=>{ down=true; sx=e.clientX-ox; sy=e.clientY-oy; img.classList.add('dragging'); });
      window.addEventListener('mouseup', ()=>{ down=false; img.classList.remove('dragging'); });
      window.addEventListener('mousemove', (e)=>{ if(!down) return; ox=e.clientX-sx; oy=e.clientY-sy; clamp(); apply(); });
      // Touch support
      let lastX=0,lastY=0,pinchDist=0,pinchStart=1;
      wrap.addEventListener('touchstart',(e)=>{ if(e.touches.length===2){ const dx=e.touches[0].clientX-e.touches[1].clientX; const dy=e.touches[0].clientY-e.touches[1].clientY; pinchDist=Math.hypot(dx,dy); pinchStart=scale; } else if(e.touches.length===1){ lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; } },{passive:true});
      wrap.addEventListener('touchmove',(e)=>{ if(e.touches.length===2){ const dx=e.touches[0].clientX-e.touches[1].clientX; const dy=e.touches[0].clientY-e.touches[1].clientY; const dist=Math.hypot(dx,dy); scale=Math.min(max,Math.max(min,pinchStart*(dist/pinchDist))); apply(); } else if(e.touches.length===1){ const nx=e.touches[0].clientX, ny=e.touches[0].clientY; ox+=(nx-lastX); oy+=(ny-lastY); lastX=nx; lastY=ny; clamp(); apply(); } },{passive:true});
      // Buttons
      document.getElementById('btnReset').addEventListener('click',()=>{ scale=1; ox=0; oy=0; apply(); });
      document.getElementById('btnZoomIn').addEventListener('click',()=>{ scale=Math.min(max, scale*1.2); apply(); });
      document.getElementById('btnZoomOut').addEventListener('click',()=>{ scale=Math.max(min, scale/1.2); apply(); });
      document.getElementById('btnFullscreen').addEventListener('click',()=>{ wrap.requestFullscreen && wrap.requestFullscreen(); });
      img.addEventListener('load', ()=>{ scale=1; ox=0; oy=0; apply(); });
      // Double-tap reset
      let lastTap=0; wrap.addEventListener('click',()=>{ const now=Date.now(); if(now-lastTap<350){ scale=1; ox=0; oy=0; apply(); } lastTap=now; });
      // Export helpers for route module
      window.__zoomAPI = { wrap, img, getState:()=>({scale, ox, oy}), setState:(s)=>{ scale=s.scale; ox=s.ox; oy=s.oy; apply(); }, clamp, apply };
    })();

    // --- Room route finder with overlay ---
    (function(){
      const rooms = {
        'Success': {x:0.06,y:0.10,w:0.10,h:0.08},
        'Inspire': {x:0.07,y:0.22,w:0.10,h:0.08},
        'Visitor Room': {x:0.06,y:0.32,w:0.10,h:0.08},
        'Joy': {x:0.10,y:0.40,w:0.10,h:0.08},
        'Debug': {x:0.36,y:0.42,w:0.10,h:0.08},
        'iDrive': {x:0.46,y:0.46,w:0.10,h:0.08},
        'M-Mode': {x:0.58,y:0.46,w:0.10,h:0.08},
        'Drift': {x:0.72,y:0.48,w:0.08,h:0.08},
        'xDrive': {x:0.80,y:0.46,w:0.08,h:0.08},
        'Torque': {x:0.88,y:0.46,w:0.08,h:0.08}
      };

      const fromSel = document.getElementById('fromRoom');
      const toSel = document.getElementById('toRoom');
      Object.keys(rooms).forEach(r=>{ const o1=document.createElement('option'); o1.value=r; o1.textContent=r; fromSel.appendChild(o1); const o2=document.createElement('option'); o2.value=r; o2.textContent=r; toSel.appendChild(o2); });
      fromSel.value='Visitor Room'; toSel.value='Success';

      const overlay = document.getElementById('overlay');
      const api = window.__zoomAPI;

      function drawMarkers(){
        overlay.innerHTML='';
        const W = overlay.clientWidth, H = overlay.clientHeight;
        // Draw room rectangles and labels
        for(const [name, r] of Object.entries(rooms)){
          const x=r.x*W, y=r.y*H, w=r.w*W, h=r.h*H;
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', w); rect.setAttribute('height', h);
          rect.setAttribute('class','marker'); rect.setAttribute('rx','6'); rect.setAttribute('ry','6');
          rect.addEventListener('click', ()=> focusRoom(name));
          overlay.appendChild(rect);
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', x+6); label.setAttribute('y', y+18);
          label.setAttribute('fill','#e8f0ff'); label.setAttribute('font-size','12'); label.textContent=name;
          overlay.appendChild(label);
        }
      }

      function focusRoom(name){
        const r = rooms[name]; if(!r) return;
        const W = api.wrap.clientWidth, H = api.wrap.clientHeight;
        const iw = api.img.naturalWidth, ih = api.img.naturalHeight;
        // Target center in image pixels
        const cx = (r.x + r.w/2)*iw; const cy = (r.y + r.h/2)*ih;
        // Desired scale to fit room nicely
        const targetScale = Math.max(2, Math.min(5, Math.min(W/(r.w*iw), H/(r.h*ih)) * 0.8));
        const s = api.getState();
        // Compute translation so that room center appears near viewport center
        const vx = W/2, vy = H/2;
        const ox = vx - cx*targetScale;
        const oy = vy - cy*targetScale;
        api.setState({scale: targetScale, ox, oy});
      }

      function routeBetween(from,to){
        drawMarkers();
        const rf=rooms[from], rt=rooms[to]; if(!rf||!rt) return;
        const W = overlay.clientWidth, H = overlay.clientHeight;
        const fx = (rf.x+rf.w/2)*W, fy=(rf.y+rf.h/2)*H;
        const tx = (rt.x+rt.w/2)*W, ty=(rt.y+rt.h/2)*H;
        const path = document.createElementNS('http://www.w3.org/2000/svg','polyline');
        path.setAttribute('points', `${fx},${fy} ${(fx+tx)/2},${fy} ${(fx+tx)/2},${ty} ${tx},${ty}`);
        path.setAttribute('fill','none'); path.setAttribute('stroke','#ff5252'); path.setAttribute('stroke-width','3'); path.setAttribute('stroke-dasharray','6,6');
        overlay.appendChild(path);
        // Pulse destination
        const destRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        destRect.setAttribute('x', rt.x*W); destRect.setAttribute('y', rt.y*H); destRect.setAttribute('width', rt.w*W); destRect.setAttribute('height', rt.h*H);
        destRect.setAttribute('class','marker pulse'); destRect.setAttribute('rx','6'); destRect.setAttribute('ry','6');
        overlay.appendChild(destRect);
      }

      function routeText(from,to){
        const steps = [
          `Start at ${from}.`,
          `Move to the main corridor.`,
          `Proceed towards ${to}.`,
          `Follow signage and safety arrows on the floorplan.`
        ];
        return steps.join(' ');
      }

      document.getElementById('btnRoute').addEventListener('click', ()=>{
        const f=fromSel.value, t=toSel.value; routeBetween(f,t); focusRoom(t);
        const text = routeText(f,t);
        document.getElementById('routeText').textContent = text;
      });
      document.getElementById('btnClear').addEventListener('click', ()=>{ overlay.innerHTML=''; drawMarkers(); document.getElementById('routeText').textContent=''; });

      // Initial draw after image loads
      window.addEventListener('load', drawMarkers);
      window.addEventListener('resize', drawMarkers);

      // Expose focusRoom for clicks
      window.focusRoom = focusRoom;
    })();

    // --- Audio guidance ---
    (function(){
      const btnSpeak = document.getElementById('btnSpeak');
      const btnStop  = document.getElementById('btnStop');
      function speak(){
        if(!('speechSynthesis' in window)){ alert('Speech Synthesis not supported in this browser.'); return; }
        const rt = document.getElementById('routeText').textContent || 'Welcome to BTI Pune. Follow the green arrows to the nearest exit and assemble at the muster point.';
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(rt);
        const voices = window.speechSynthesis.getVoices();
        const prefer = voices.find(v=>/en-IN/i.test(v.lang)) || voices.find(v=>/en/i.test(v.lang));
        if(prefer) u.voice = prefer; u.rate = 1; u.pitch = 1; u.volume = 1;
        window.speechSynthesis.speak(u);
      }
      btnSpeak.addEventListener('click', speak);
      btnStop.addEventListener('click', ()=> window.speechSynthesis.cancel());
      window.speechSynthesis.onvoiceschanged = function(){ /* Safari/Chrome async voices */ };
    })();

    // Print
    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  </script>
</body>
</html>
